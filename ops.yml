dependencies:
  brew:
    - crystal
    - node
  custom:
    - shards
    - cd webui && npm i && cd ..
hooks:
  before:
    - mkdir -p bin/release bin/debug
    - (test -f "config/$environment/$APP.$CONFIG" && ln -sf config/$environment/$APP.$CONFIG) || true
actions:
  build-webui:
    command: cd webui && npm run build && cd ..
    description: Build the Svelte-based web UI
  build-release:
    command: ops build-webui && SHARDS_BIN_PATH=bin/release shards build $APP --release
    description: Build for release
    alias: br
  build-debug:
    command: SHARDS_BIN_PATH=bin/debug shards build $APP --debug
    description: Build for development (debugging)
    aliases: [build, bd]
  install:
    quiet: true
    description: Build a release and copy it into the '$INSTALL_DIR' folder
    command: |
      BRANCH=$(git branch --show-current)
      [ "$BRANCH" == "main" ] || echo 1>&2 "ops: WARNING: not on 'main' branch."

      if [ -e "$INSTALL_DIR" ]; then
        ops build-release && cp bin/release/$APP "$INSTALL_DIR/"
      else
        echo 1>&2 "ops: The directory '$INSTALL_DIR' does not exist."
      fi
  run:
    command: ops build-webui && ops build-debug && bin/debug/$APP
    description: Build and run the debug build of Enkaidu
    load_secrets: true
  run_release:
    command: ops build-release && bin/release/$APP
    alias: rr
    description: Build for release and then run the app
    load_secrets: true
  clean:
    command: rm -rf bin/debug/* && rm -rf bin/release/* && rm -rf webui/dist
    description: Clear prior builds
  wipe:
    command: crystal clear_cache && ops clean
    description: Clear build caches and prior builds
  lint:
    command: bin/ameba src/
    description: Run Crystal source linter (ameba)
  test:
    command: crystal spec -Dtest
    description: Run all tests (spectator)
  just-run-debug:
    alias: jrun
    description: Just run the debug build; assume `ops build` was run already.
    command: bin/debug/$APP
    load_secrets: true
  just-run-release:
    alias: jrr
    description: Just run the release build; assume `ops br` was run already.
    command: bin/release/$APP
    load_secrets: true
options:
  environment:
    APP: enkaidu
    CONFIG: yaml
    INSTALL_DIR: "$HOME/bin"

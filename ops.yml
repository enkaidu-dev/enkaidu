dependencies:
  brew:
    - crystal
  custom:
    - shards
hooks:
  before:
    - mkdir -p bin/release bin/debug
    - test -f "config/$environment/$APP.$CONFIG" && ln -sf config/$environment/$APP.$CONFIG
actions:
  build-release:
    command: SHARDS_BIN_PATH=bin/release shards build $APP --release
    description: Build for release
    alias: br
  build-debug:
    command: SHARDS_BIN_PATH=bin/debug shards build $APP --debug
    description: Build for development (debugging)
    aliases: [build, bd]
  install:
    quiet: true
    command: |
      BRANCH=$(git branch --show-current)
      [ "$BRANCH" == "main" ] || echo 1>&2 "ops: WARNING: not on 'main' branch."

      if [ -e "$INSTALL_DIR" ]; then
        ops build-release && cp bin/release/$APP "$INSTALL_DIR/"
      else
        echo 1>&2 "ops: The directory '$INSTALL_DIR' does not exist."
      fi
  run:
    command: ops build-debug && bin/debug/$APP
    load_secrets: true
  run_release:
    command: ops build-release && bin/release/$APP
    alias: rr
    description: Build for release and then run the app
    load_secrets: true
  clean:
    command: rm -rf bin/debug/* && rm -rf bin/release/* && rm $APP.json $APP.yaml
    description: Clear prior builds
  wipe:
    command: crystal clear_cache && ops clean
    description: Clear build caches and prior builds
  lint:
    command: bin/ameba --all
  just-run-debug:
    alias: jrun
    description: Run the debug build; make sure to run `ops build` before.
    command: bin/debug/$APP
    load_secrets: true
  just-run-release:
    alias: jrelrun
    description: Run the release build; make sure to run `ops br` before.
    command: bin/release/$APP
    load_secrets: true
options:
  environment:
    APP: enkaidu
    CONFIG: yaml
    INSTALL_DIR: "$HOME/bin"
